/*!
 * backbone.layoutmanager.js v0.8.8
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */

(function(e){var t,n=e.Backbone,r=e._,i=n.$,s=e.console&&e.console.warn,o=e.console&&e.console.trace,u=n.View.prototype._configure,a=n.View.prototype.render,f=Array.prototype.push,l=Array.prototype.concat,c=Array.prototype.splice,h=n.View.extend({constructor:function(t){t=t||{},h.setupView(this,t),n.View.call(this,t)},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return r.isArray(e)?this.setViews({"":e}):(r.each(e,function(t,n){e[n]=r.isArray(t)?t:[t]}),this.setViews(e))},getView:function(e){return e==null&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var t;return typeof e=="string"?(t=this.views[e]||[],r.chain([].concat(t))):(t=r.chain(this.views).map(function(e){return r.isArray(e)?e:[e]},this).flatten(),typeof e=="object"?t.where(e):typeof e=="function"?t.filter(e):t)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,t,n){var i,s,o,u=this;typeof e!="string"&&(n=t,t=e,e=""),this.views=this.views||{},i=t.__manager__,s=this.views[e];if(!i)throw new Error("Please set `View#manage` property with selector '"+e+"' to `true`.");return o=t.getAllOptions(),i.parent=u,i.selector=e,t.on("all",function(e){e!=="beforeRender"&&e!=="afterRender"&&u.trigger.apply(u,arguments)},t),n?(this.views[e]=l.call([],s||[],t),i.insert=!0,t):(i.hasRendered&&o.partial(u.$el,t.$el,u.__manager__,i),s&&r.each(l.call([],s),function(e){e.remove()}),this.views[e]=t)},setViews:function(e){return r.each(e,function(e,t){if(r.isArray(e))return r.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(){function c(){function c(){var r=n.afterRender;r&&r.call(t,t),t.trigger("afterRender",t),i.noel&&t.$el.length>1&&s&&!n.suppressWarnings&&(e.console.warn("Using `el: false` with multiple top level elements is not supported."),o&&e.console.trace())}var r,f;return u&&(n.contains(u.el,t.el)||n.partial(u.$el,t.$el,a,i)),t.delegateEvents(),i.hasRendered=!0,(r=i.queue.shift())?r():delete i.queue,a&&a.queue?u.once("afterRender",c):c(),l.resolveWith(t,[t])}function p(){var e=t.getAllOptions(),n=t.__manager__,i=n.parent,s=i&&i.__manager__;t._render(h._viewRender,e).done(function(){if(!r.keys(t.views).length)return c();var n=r.map(t.views,function(e){var t=r.isArray(e);return t&&e.length?r.reduce(e.slice(1),function(e,t){return e.then(function(){return t.render()})},e[0].render()):t?e:e.render()});e.when(n).done(c)})}var t=this,n=t.getAllOptions(),i=t.__manager__,u=i.parent,a=u&&u.__manager__,l=n.deferred();return i.queue?f.call(i.queue,p):(i.queue=[],p(t,l)),l.view=t,l},remove:function(){return h._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return r.extend({},this,h.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e,t){function f(n){r.isString(n)&&(a.noel?(n=i.trim(n),u=i(n),e.$el.slice(1).remove(),e.$el.replaceWith(u),e.setElement(u,!1)):t.html(e.$el,n)),o.resolveWith(e,[e])}function l(e,r){var i,s=h._makeAsync(t,function(e){f(e)});h.cache(n,r),r&&(i=t.render.call(s,r,e)),s._isAsync||f(i)}var n,s,o,u,a=e.__manager__;return{render:function(){var i=e.serialize||t.serialize,u=e.template||t.template;return r.isFunction(i)&&(i=i.call(e)),o=h._makeAsync(t,function(e){l(i,e)}),typeof u=="string"&&(n=t.prefix+u),(s=h.cache(n))?(l(i,s,n),o):(typeof u=="string"?s=t.fetch.call(o,t.prefix+u):typeof u=="function"?s=u:u!=null&&(s=t.fetch.call(o,u)),o._isAsync||l(i,s),o)}}},_removeViews:function(e,t){var n;typeof e=="boolean"&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.__manager__.hasRendered||t)&&h._removeView(e,t)})},_removeView:function(e,t){var n,i=e.__manager__,s=typeof e.keep=="boolean"?e.keep:e.options.keep;if(!s&&i.insert===!0||t){h.cleanViews(e),e._removeViews(!0),e.$el.remove();if(!i.parent)return;n=i.parent.views[i.selector];if(r.isArray(n))return r.each(r.clone(n),function(e,t){e&&e.__manager__===i&&c.call(n,t,1)});delete i.parent.views[i.selector]}},cache:function(e,t){if(e in this._cache&&t==null)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},cleanViews:function(e){r.each(l.call([],e),function(e){var t;e.unbind(),e.model instanceof n.Model&&e.model.off(null,null,e),e.collection instanceof n.Collection&&e.collection.off(null,null,e),e.stopListening(),t=e.getAllOptions().cleanup,r.isFunction(t)&&t.call(e)})},configure:function(e){r.extend(h.prototype.options,e),e.manage&&(n.View.prototype.manage=!0),e.el===!1&&(n.View.prototype.el=!1),e.suppressWarnings===!0&&(n.View.prototype.suppressWarnings=!0)},setupView:function(e,i){r.each(l.call([],e),function(e){if(e.__manager__)return;var s,o,u,a=h.prototype,f=r.pick(e,t);r.defaults(e,{views:{},__manager__:{},_removeViews:h._removeViews,_removeView:h._removeView},h.prototype),i=e.options=r.defaults(i||{},e.options,a.options),u=r.pick(i,l.call(["events"],r.values(i.events))),r.extend(e,u),(f.render===h.prototype.render||f.render===n.View.prototype.render)&&delete f.render,r.extend(i,f),e._remove=n.View.prototype.remove,e._render=function(e,t){var n=this,r=n.__manager__,i=t.beforeRender;return r.hasRendered&&this._removeViews(),i&&i.call(this,this),this.trigger("beforeRender",this),e(this,t).render()},e.render=h.prototype.render,e.remove!==a.remove&&(e._remove=e.remove,e.remove=a.remove),s=i.views||e.views,r.keys(s).length&&(o=s,e.views={},e.setViews(o)),e.options.template?e.options.template=i.template:e.template&&(i.template=e.template)})}});n.Layout=h,h.VERSION="0.8.8",n.View.prototype._configure=function(e){var t,n;if("el"in e?e.el===!1:this.el===!1)t=!0;return n=u.apply(this,arguments),(e.manage||this.manage)&&h.setupView(this),this.__manager__&&(this.__manager__.noel=t,this.__manager__.suppressWarnings=e.suppressWarnings),n},h.prototype.options={prefix:"",deferred:function(){return i.Deferred()},fetch:function(e){return r.template(i(e).html())},partial:function(e,t,n,r){if(r.selector)if(n.noel){var i=e.filter(r.selector);e=i.length?i:e.find(r.selector)}else e=e.find(r.selector);r.insert?this.insert(e,t):this.html(e,t)},html:function(e,t){e.html(t)},insert:function(e,t){e.append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)},contains:function(e,t){return i.contains(e,t)}},t=r.keys(h.prototype.options)})(typeof global=="object"?global:this);